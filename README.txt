#########################################################################################################

1) Copy the patch file in the kernel source
2) Run patch -p1 < sri.patch at kernel source
3) Then build the kernel
	export the path as given in assignment pdf
	by running export PATH=path_to_sdk/sysroots/x86_64-pokysdk-linux/usr/bin/i586-poky-linux:$PATH
	build by running ARCH=x86 LOCALVERSION= CROSS_COMPILE=i586-poky-linux- make -j4
	while building it will ask for Enable dynamic dump stack just type y
	run ARCH=x86LOCALVERSION=  INSTALL_MOD_PATH=../galileo-installCROSS_COMPILE=i586-poky-linux-make modules_install
	copy bz image into galileo-install folder cp arch/x86/boot/bzImage ../galileo-install/

4) copy bz image to sd card Plug in the SD card to board and reboot

#########################################################################################################

How to run test program

Do make and run by ./syscall_test

#########################################################################################################

WORKING OF MY CODE

I created two system calls insdump and rmdump to dynamically dump the stack.
I kept a kprobe at user sent symbol such that when ever that any process hits that my pre handler will get executed in that i am performing my necessary operations
I kept a kprobe at do_exit as well to test for the condition when a process is killed or exited it will call do_exit it will triger my probe function in that i am removing all kprobes inserted by the parent process
By checking realparent id tread group id and pid i am validating various conditions to dumpstack

in my user application i am testing my functionalities by creating child process by fork and creating threads to verify my logic

#########################################################################################################

SAMPLE OUTPUT
---------------------------------------------------------------------------------------------------------

RUN 1

---------------------------------------------------------------------------------------------------------


quark login: root
root@quark:~# ./syscall_test
[  115.009504] INSIDE THE SYSTEM CALL INSDUMP
[  115.013911] COPYIED SYMBOL IS sys_open
[  115.029018] SYMOBOL PRESENT
[  115.033355] DUMPSTACK MODE COPYIED IS  0
[  115.037327] REGISTERING INSDUMP KPROBE AT ADDRESS c111af10
[  115.051388] DO_EXIT SYMBOL FOUND
[  115.054667] REGISTERING PROCESS EXIT KPROBE AT ADDRESS c1038e10
[  115.071073] INSIDE THE SYSTEM CALL INSDUMP
[  115.075224] COPYIED SYMBOL IS sys_close
[  115.090466] SYMOBOL PRESENT
[  115.096450] DUMPSTACK MODE COPYIED IS  1
[  115.100548] REGISTERING INSDUMP KPROBE AT ADDRESS c1119760
IN CHILD PROCESS[  116.108849] INCOMING PROCESS PID IS 297
[  116.114082] INCOMING PROCESS TGID IS 297
[  116.118119] INCOMING PROCESS REAL_PARENT_ID IS 296
[  116.118252] MAIN PROCESS PID IS 296
[  116.118252] MAIN PROCESS TGID IS 296
[  116.118252] MAIN PROCESS REAL_PARENT_ID IS 279

[  116.140272] INCOMING PROCESS PID IS 297
[  116.144238] INCOMING PROCESS TGID IS 297
[  116.148275] INCOMING PROCESS REAL_PARENT_ID IS 296
[  116.150049] MAIN PROCESS PID IS 296
[  116.150049] MAIN PROCESS TGID IS 296
[  116.150049] MAIN PROCESS REAL_PARENT_ID IS 279
[  116.172309] IN THE SYSCALL RMDUMP
[  116.175670] DUMPSTACK NOT FOUND
ERROR WHILE REMOVING THE DUMPSTACK
OPENING THE FILE[  116.182633] INCOMING PROCESS PID IS 298
[  116.187896] INCOMING PROCESS TGID IS 297
[  116.190080] INCOMING PROCESS REAL_PARENT_ID IS 296
[  116.190080] MAIN PROCESS PID IS 296
[  116.190080] MAIN PROCESS TGID IS 296
[  116.190080] MAIN PROCESS REAL_PARENT_ID IS 279
 FROM THREAD  
[  116.210358] INCOMING PROCESS PID IS 231
[  116.214324] INCOMING PROCESS TGID IS 226
[  116.218358] INCOMING PROCESS REAL_PARENT_ID IS 1
[  116.220032] MAIN PROCESS PID IS 296
[  116.220032] MAIN PROCESS TGID IS 296
[  116.220032] MAIN PROCESS REAL_PARENT_ID IS 279
[  116.235202] INCOMING PROCESS PID IS 298
[  116.239167] INCOMING PROCESS TGID IS 297
[  116.243204] INCOMING PROCESS REAL_PARENT_ID IS 296
[  116.244972] MAIN PROCESS PID IS 296
[  116.244972] MAIN PROCESS TGID IS 296
[  116.244972] MAIN PROCESS REAL_PARENT_ID IS 279
[  116.270199] INCOMING PROCESS PID IS 231
[  116.274164] INCOMING PROCESS TGID IS 226
[  116.278198] INCOMING PROCESS REAL_PARENT_ID IS 1
[  116.280047] MAIN PROCESS PID IS 296
[  116.280047] MAIN PROCESS TGID IS 296
[  116.280047] MAIN PROCESS REAL_PARENT_ID IS 279
[  116.309224] INCOMING PROCESS PID IS 231
[  116.310052] INCOMING PROCESS TGID IS 226
[  116.310052] INCOMING PROCESS REAL_PARENT_ID IS 1
[  116.310052] MAIN PROCESS PID IS 296
[  116.310052] MAIN PROCESS TGID IS 296
[  116.310052] MAIN PROCESS REAL_PARENT_ID IS 279
[  118.006215] INCOMING PROCESS PID IS 270
[  118.010181] INCOMING PROCESS TGID IS 270
[  118.014216] INCOMING PROCESS REAL_PARENT_ID IS 1
[  118.015731] MAIN PROCESS PID IS 296
[  118.015731] MAIN PROCESS TGID IS 296
[  118.015731] MAIN PROCESS REAL_PARENT_ID IS 279
[  118.107852] INCOMING PROCESS PID IS 296
[  118.111818] INCOMING PROCESS TGID IS 296
[  118.115854] INCOMING PROCESS REAL_PARENT_ID IS 279
[  118.117697] MAIN PROCESS PID IS 296
[  118.117697] MAIN PROCESS TGID IS 296
[  118.117697] MAIN PROCESS REAL_PARENT_ID IS 279
[  118.117697] CPU: 0 PID: 296 Comm: syscall_test Not tainted 3.19.8-yocto-standard #1
[  118.117697] Hardware name: Intel Corp. QUARK/GalileoGen2, BIOS 0x01000200 01/01/2014
[  118.117697]  ce623104 ce623104 cd7b5f30 c1453b01 cd7b5f48 c124cefc 00000128 ce623104
[  118.117697]  cd21b120 cd7b5f74 cd7b5f60 c10a2762 ce62310c 00000246 00000001 08048530
[  118.117697]  cd7b5f6c c102853a 08048888 cd7b4000 d277101b 08048888 00000002 000000e0
[  118.117697] Call Trace:
[  118.117697]  [<c1453b01>] dump_stack+0x16/0x18
[  118.117697]  [<c124cefc>] Pre_Handler+0x9c/0xb0
[  118.117697]  [<c10a2762>] opt_pre_handler+0x32/0x60
[  118.117697]  [<c102853a>] optimized_callback+0x5a/0x70
[  118.117697]  [<c1070000>] ? unmask_threaded_irq+0x40/0x40
[  118.117697]  [<c111af11>] ? SyS_open+0x1/0x20
[  118.117697]  [<c1457504>] ? syscall_call+0x7/0x7
[  118.210172] IN THE SYSCALL RMDUMP
[  118.213532] DUMPSTACK FOUND!! REMOVING THE PROBE
OPENING THE FILE[  119.219990] INCOMING PROCESS PID IS 299
[  119.225171] INCOMING PROCESS TGID IS 296
[  119.228274] INCOMING PROCESS REAL_PARENT_ID IS 279
[  119.228274] MAIN PROCESS PID IS 296
[  119.228274] MAIN PROCESS TGID IS 296
[  119.228274] MAIN PROCESS REAL_PARENT_ID IS 279
[  119.228274] CPU: 0 PID: 299 Comm: syscall_test Not tainted 3.19.8-yocto-standard #1
[  119.228274] Hardware name: Intel Corp. QUARK/GalileoGen2, BIOS 0x01000200 01/01/2014
[  119.228274]  cd44cd04 cd44cd04 ce757f30 c1453b01 ce757f48 c124cefc 0000012b cd44cd04
[  119.228274]  cd21b420 ce757f74 ce757f60 c10a2762 cd44cd0c 00000246 00000000 b77a6b40
[  119.228274]  ce757f6c c102853a ffffffff ce756000 d277109d ffffffff 00000000 000000e0
[  119.228274] Call Trace:
[  119.228274]  [<c1453b01>] dump_stack+0x16/0x18
[  119.228274]  [<c124cefc>] Pre_Handler+0x9c/0xb0
[  119.228274]  [<c10a2762>] opt_pre_handler+0x32/0x60
[  119.228274]  [<c102853a>] optimized_callback+0x5a/0x70
[  119.228274]  [<c1119761>] ? SyS_close+0x1/0x40
[  119.228274]  [<c1457504>] ? syscall_call+0x7/0x7
 FROM THREAD  
[  119.320553] PROBES - SYMBOL sys_close PROCESS PID 296 IS EXITED. REMOVING THE KRP



---------------------------------------------------------------------------------------------------------

RUN 2

---------------------------------------------------------------------------------------------------------


root@quark:~# ./syscall_test
[  229.979105] INSIDE THE SYSTEM CALL INSDUMP
[  229.983351] COPYIED SYMBOL IS sys_open
[  229.998447] SYMOBOL PRESENT
[  230.002818] DUMPSTACK MODE COPYIED IS  0
[  230.006790] REGISTERING INSDUMP KPROBE AT ADDRESS c111af10
[  230.018020] INSIDE THE SYSTEM CALL INSDUMP
[  230.023371] COPYIED SYMBOL IS sys_close
[  230.038522] SYMOBOL PRESENT
[  230.043692] DUMPSTACK MODE COPYIED IS  1
[  230.047664] REGISTERING INSDUMP KPROBE AT ADDRESS c1119760
IN CHILD PROCESS[  231.058158] INCOMING PROCESS PID IS 302
[  231.063388] INCOMING PROCESS TGID IS 302
[  231.067424] INCOMING PROCESS REAL_PARENT_ID IS 301
[  231.067576] MAIN PROCESS PID IS 301
[  231.067576] MAIN PROCESS TGID IS 301
[  231.067576] MAIN PROCESS REAL_PARENT_ID IS 279

[  231.090224] INCOMING PROCESS PID IS 302
[  231.094190] INCOMING PROCESS TGID IS 302
[  231.098224] INCOMING PROCESS REAL_PARENT_ID IS 301
[  231.100052] MAIN PROCESS PID IS 301
[  231.100052] MAIN PROCESS TGID IS 301
[  231.100052] MAIN PROCESS REAL_PARENT_ID IS 279
[  231.121709] IN THE SYSCALL RMDUMP
[  231.125069] DUMPSTACK NOT FOUND
ERROR WHILE REMOVING THE DUMPSTA[  231.129791] INCOMING PROCESS PID IS 303
[  231.130052] INCOMING PROCESS TGID IS 302
[  231.130052] INCOMING PROCESS REAL_PARENT_ID IS 301
[  231.130052] MAIN PROCESS PID IS 301 
[  231.130052] MAIN PROCESS TGID IS 301 
[  231.130052] MAIN PROCESS REAL_PARENT_ID IS 279 
CK
OPENING THE FILE FROM THREAD
[  231.160183] INCOMING PROCESS PID IS 303 
[  231.164148] INCOMING PROCESS TGID IS 302 
[  231.168185] INCOMING PROCESS REAL_PARENT_ID IS 301 
[  231.170037] MAIN PROCESS PID IS 301 
[  231.170037] MAIN PROCESS TGID IS 301 
[  231.170037] MAIN PROCESS REAL_PARENT_ID IS 279 
[  233.055114] INCOMING PROCESS PID IS 301 
[  233.059081] INCOMING PROCESS TGID IS 301 
[  233.063115] INCOMING PROCESS REAL_PARENT_ID IS 279 
[  233.064966] MAIN PROCESS PID IS 301 
[  233.064966] MAIN PROCESS TGID IS 301 
[  233.064966] MAIN PROCESS REAL_PARENT_ID IS 279 
[  233.064966] CPU: 0 PID: 301 Comm: syscall_test Not tainted 3.19.8-yocto-standard #1
[  233.064966] Hardware name: Intel Corp. QUARK/GalileoGen2, BIOS 0x01000200 01/01/2014
[  233.064966]  ce7fc104 ce7fc104 cd7b5f30 c1453b01 cd7b5f48 c124cefc 0000012d ce7fc104
[  233.064966]  cd7d4b40 cd7b5f74 cd7b5f60 c10a2762 ce7fc10c 00000246 00000001 08048530
[  233.064966]  cd7b5f6c c102853a 08048888 cd7b4000 d27710de 08048888 00000002 000000e0
[  233.064966] Call Trace:
[  233.064966]  [<c1453b01>] dump_stack+0x16/0x18
[  233.064966]  [<c124cefc>] Pre_Handler+0x9c/0xb0
[  233.064966]  [<c10a2762>] opt_pre_handler+0x32/0x60
[  233.064966]  [<c102853a>] optimized_callback+0x5a/0x70
[  233.064966]  [<c1070000>] ? unmask_threaded_irq+0x40/0x40
[  233.064966]  [<c111af11>] ? SyS_open+0x1/0x20
[  233.064966]  [<c1457504>] ? syscall_call+0x7/0x7
[  233.160185] IN THE SYSCALL RMDUMP
[  233.163545] DUMPSTACK FOUND!! REMOVING THE PROBE
OPENING THE FILE[  234.170016] INCOMING PROCESS PID IS 304
[  234.175195] INCOMING PROCESS TGID IS 301
[  234.178290] INCOMING PROCESS REAL_PARENT_ID IS 279
[  234.178290] MAIN PROCESS PID IS 301
[  234.178290] MAIN PROCESS TGID IS 301
[  234.178290] MAIN PROCESS REAL_PARENT_ID IS 279
[  234.178290] CPU: 0 PID: 304 Comm: syscall_test Not tainted 3.19.8-yocto-standard #1
[  234.178290] Hardware name: Intel Corp. QUARK/GalileoGen2, BIOS 0x01000200 01/01/2014
[  234.178290]  ce7fc904 ce7fc904 ce753f30 c1453b01 ce753f48 c124cefc 00000130 ce7fc904
[  234.178290]  cd7d4f00 ce753f74 ce753f60 c10a2762 ce7fc90c 00000246 00000000 b77f3b40
[  234.178290]  ce753f6c c102853a ffffffff ce752000 d277111f ffffffff 00000000 000000e0
[  234.178290] Call Trace:
[  234.178290]  [<c1453b01>] dump_stack+0x16/0x18
[  234.178290]  [<c124cefc>] Pre_Handler+0x9c/0xb0
[  234.178290]  [<c10a2762>] opt_pre_handler+0x32/0x60
[  234.178290]  [<c102853a>] optimized_callback+0x5a/0x70
[  234.178290]  [<c1119761>] ? SyS_close+0x1/0x40
[  234.178290]  [<c1457504>] ? syscall_call+0x7/0x7
 FROM THREAD  
[  234.270561] PROBES - SYMBOL sys_close PROCESS PID 301 IS EXITED. REMOVING THE KRPOBES
root@quark:~# 


---------------------------------------------------------------------------------------------------------
